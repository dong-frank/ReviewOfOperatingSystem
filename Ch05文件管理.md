# Ch05 文件管理

## 文件系统概述

### 文件的概念
文件是具有符号名的, 在逻辑上具有完整意义的一组相关信息项的序列

文件的命名: 一般包括文件名和扩展名
- 前者用于识别文件
- 后者用于标识文件特性

文件的分类
- 按用途可分为系统文件, 库文件, 用户文件
- 按保护级别可分为只读文件, 读写文件, 不保护文件
- 按信息时限可分为临时文件, 永久文件, 档案文件
- 按设备类型可分为磁盘文件, 磁带文件, 光盘文件, 软盘文件
- 还可以按文件的逻辑结构或物理结构分类

引入文件的优点
- 用户使用方便, 实现了**按名存取**
- 文件安全可靠
- 文件可备份
- 文件可共享
- 把数据组织成文件形式加以管理和控制是计算机数据管理的重大进展

### 文件系统及其功能
文件系统是OS中负责存取和管理信息的模块

文件系统中的文件
- 文件不但反映了用户概念中的逻辑结构
- 而且和存放它的辅助存储器(文件存储器)的存储结构紧密相关
- 所以同一个文件必须从逻辑文件和物理文件两个方面观察

文件系统的功能(面向用户)
- 文件的按名存取
- 文件的共享和保护
- 文件的操作和使用

为了实现这些功能, OS必须考虑
- 文件目录的建立和维护
- 存储空间的分配和回收
- 数据的保密和保护
- 监督用户存取和修改文件的权限
- 实现在不同存储介质上信息的表示方式, 编址方式, 存储次序以及信息的检索问题

## 文件的组织

### 文件的存储
文件存储介质有磁带, 光盘和磁盘
- 卷是存储介质的物理单位, 对应于一盘磁带, 一块软盘, 一个光盘, 一个硬盘分区
- 块是存储介质上连续信息所组成的一个区域, 也叫做物理记录
- 块是主存储器和辅助存储器进行信息交换的物理单位, 每次总是交换一块或整数块的信息

块
- 决定块的大小要考虑用户使用方式, 数据传输效率和设备类型等多种因素
- 不同类型的存储介质, 块的大小往往不同, 同一类型的存储介质, 块的大小一般相同
- 外围由于启停机械动作或识别不同块的要求, **两个相邻块之间必须留有间隙**
  - 间隙不用来记录信息

#### 顺序存取存储设备的信息安排
顺序存取设备严格依赖信息的物理位置次序进行定位和读写 *磁带机, 光盘*

存储容量大, 稳定可靠, 卷可装卸和便于保存等优点, 广泛用作存档

磁带的一个突出特点是块的大小变化范围较大

#### 直接存取存储设备的信息安排
磁盘是一种直接存取存储设备, 又叫随机存取存储设备

通过移臂和旋转两维组织, 存取速度高

每个物理记录有确定的位置和唯一的地址, 存取任何一个物理块所需的时间几乎不依赖于次信息的位置


### 文件的逻辑结构
逻辑文件, 又称为文件的逻辑结构
- 独立于物理环境的, 用户概念中的抽象信息组织方式
- 是用户能观察到的, 并加以处理的数据集合

文件的**逻辑结构**分为两种形式
- 流式文件: 文件内的数据不再组成记录, 只是由一串依次的字节组成的信息流序列
- 记录式文件: 是一种有结构的文件, 是若干逻辑记录信息所组成的记录流文件

数据库管理系统也支持逻辑记录
- 但数据库有别于记录式文件
- 数据库中的记录之间可以通过数据冗余构成某种联系
- 数据库管理系统支持基于联系的数据查询, 文件系统则不行

### 记录的成组与分解
若一个物理记录只存放一个逻辑记录可能造成极大浪费

将若干个逻辑记录合并成一组, 写入一个块叫**记录的成组**, 每块中的逻辑记录数称块因子

对于流式文件, 一个物理记录可以存放很多个连续字节

成组与分解操作
- 系统设置独立于用户数据区的输入/输出缓存区
- 记录的成组操作在输出缓冲区内进行, 凑满一块后才将缓冲区内的信息写到存储介质上
- 当存储介质上的一个物理记录读进输入缓冲区后, 把逻辑记录从块中分离出来的操作叫记录的分解操作

对于定长的记录
- 使用固定组块, 若干个完整的记录组成一块, 块内存在内部碎片

对于变长记录
- 使用可变长度非跨越式组块, 记录长度是可变的, 但不会跨越块存储, 大多数情况都有内部碎片
- 使用可变长度跨越式组块, 块中没有未使用空间, 某些记录可能会跨越两个块, 通过一个指向后继块的指针连接

成组与分解的特点
- 记录成组与分解不仅节省内存空间, 还能减少输入输出操作次数, 提高系统效率
- 用户读请求, 会将包含该逻辑记录的物理块读入输入缓冲区, 可能读入多个逻辑记录 **提前读**
- 用户写请求, 首先写入输出缓冲区, 写满后才实际输出 **推迟写**

### 文件的物理结构
文件的**物理结构**和组织是指文件在物理存储空间中的存放方式和组织关系

又称物理文件

文件的存储结构涉及块的划分, 记录的排列, 索引的组织, 信息的搜索等许多问题 **直接影响文件系统的性能**

#### 顺序文件
将一个文件中逻辑上连续的信息, 存放到存储介质的依次相邻的块中


优点
- 顺序存取记录时速度较快
缺点
- 建立文件前需要能预先确定文件长度, 以便分配存储空间
- 修改, 插入和增加文件记录困难
- 跳转存取记录速度很慢 *磁带的倒带*

#### 连接文件
又称串联文件, 使用连接字来表示文件中各个物理块之间的先后次序

第一块文件信息的物理地址由文件目录给出, 而每一块的连接字指出了文件的下一个物理块位置, 连接字内容为0时, 表示文件至本块结束

*输入井, 输出井等都用此类文件*

优点
- 易于对文件记录做修改, 易于动态增长记录(链表), 不必预先知道文件长度, 存储空间利用率高(不必相邻存放)
缺点
- 存放连接字需要额外的空间
- 由于存取须通过缓冲区, 待获得链接字后才能找到下一个物理块的地址, 因而仅适用于顺序存取

#### 直接文件
又称散列文件, 通过计算记录的关键字建立与物理存储地址之间的对应关系

因为是采用Hash散列, 可能会出现冲突, 需要避免散列的冲突

#### 索引文件
索引文件为每个文件建立了一张索引表, 表的每一项包含了一个记录的键及其物理存储地址

索引表的地址可由文件目录指出, 查阅索引表先找到相应记录键, 然后获得数据存储地址

索引文件的访问方式
- 索引文件在文件存储器上分两个区: 索引区和数据区
- 第一步查找索引表, 第二步获得记录的物理地址
- 需要两次访问辅助存储器, 若文件索引已预先调入主存储器, 那么就可以减少一次

特点
- 索引结构是连接结构的一种扩展
- 克服了链接结构只能顺序存取的缺点
- 缺点是增加了索引表的空间开销和查找时间

索引表的组织(类似多级页表的组织)
- 一级索引
- 两级索引
- 多级索引
## 文件目录
### 文件目录结构
文件目录是实现文件的**按名存取**的关键数据结构

文件系统的基本功能之一就是负责文件目录的建立, 维护和检索, 要求编排的目录便于查找, 防止冲突

文件目录需要永久保存, 因此也组织成文件存放在磁盘上, 称为目录文件

#### 一级目录结构
在OS中构造一张线性表, 每个文件的相关属性占用一个目录项

**由于用户与文件众多, 容易重名, 不利记忆**

#### 二级目录结构
第一级为主文件目录, 用于管理所有用户文件目录, 目录项登记了系统接受的用户的名字及该用户文件目录的地址

第二级为用户的文件目录, 为该用户的每个文件保存一个登记栏

每一用户只允许查看自己的文件目录

特点
- 通过主文件目录可以检查访问文件者的存取权限
- 当不同用户具有同名文件时不会导致混乱
- 但对于同一个用户, 同样存在文件多, 容易重名问题

#### 树形目录结构
每一级目录可以登记下一级目录, 也可以登记文件, 从而形成了层次文件目录

层次目录结构通常采用树形目录结构, 树根是根目录, 树叶是文件

特点
- 较好地反映现实世界中具有层次关系的数据集合, 较确切地反映系统内部文件的组织结构
- 不同文件可以重名, 只要它们不位于同一末端的子目录中
- 易于规定不同层次或子树中文件的不同存取权限, 便于文件的保护, 保密和共享

若规定每个文件都只有一个父目录, 称为纯树型目录结构, 缺点是文件共享不是对称的, 要想获得文件的访问权限, 必须要获得其父目录的权限

有向无环图目录允许文件有多个父目录, 为每个文件维护一个引用计数用来记录文件的父目录个数 *Linux中的link, Windows中的快捷方式*


### 文件目录的管理
#### 文件查找
按名存取文件就是系统根据用户提供的文件路径名来搜索各级文件目录, 找到该文件
w
#### 目录项查找
在搜索具体目录项时, 可以采用顺序查找法, 也可以采用一些优化 *二分查找法, 杂凑法*

#### 文件目录处理
树形目录结构存在的一个问题是
- 当一个文件经过许多目录节点时
- 系统在沿路径查找目录时, 往往要多次访问文件存储器, 访问速度大大减慢
- 若把所有文件目录复制到主存, 又增加了主存的开销
- 一种有效的办法是把常用和正在使用的复制进主存

活动文件表
- 系统为每个用户进程建立一张活动文件表
- 当用户使用一个文件时, 先通过"打开", 把该文件有关目录信息复制到指定主存区域, 把有关信息填入活动文件表, 以建立用户进程和该文件索引的联系
- 当不再使用该进程时, 使用"关闭"切断用户进程和这个文件的联系, 同时若被修改过, 要相应地在辅存中更新

### Linux特殊目录项建立方法
Linux系统的FCB(目录项)中的文件名和其他管理信息分开, 其他管理信息单独组成一个数据结构, 称为索引节点inode, 此索引节点在磁盘上的位置由inode号标识

#### Inode
文件系统中的每个文件都有一个磁盘inode与之对应, 被集中放在磁盘上的inode区

FCB对于文件的作用类似PCB对于进程的作用, 集中这个文件的所有相关信息, 找到inode就能获得此文件的必要信息

数据块索引在union结构中, ```i_data[15]```数组给出数据块地址索引, 前12项为直接索引, 第13项为一次间接索引, 第14项为二次间接索引, 第15项为三次间接索引

磁盘inode记录文件的属性和相关信息, 文件访问过程会频繁使用到, 不断来回于内外存之间使用开销很大

为此在内存区开辟一张活动inode表, 磁盘中的inode区反映文件的静态特性, 活动inode反映文件动态特性 **又是一个类似cache的使用**

在有向无环图目录结构中, 多个目录项是可以指向同一个Inode, Inode中的连接计数记录连接的目录项数

### 文件系统的磁盘结构
1. 超级块: 占用#1号块, 存放文件系统结构和管理信息
2. 索引节点区(磁盘Inode区): 存放Inode表, 每个文件在Inode表中都有一个Inode
3. 数据区: 文件的内容


重要的数据结构
1. 用户打开文件表: 进程的PCB中保留一个```files_struct```, 称为用户打开文件表或文件描述符表, 表项的序号为文件描述符fd, 登记系统打开文件表的一个入口指针fp
2. 系统打开文件表: 为解决多用户进程共享文件, 当打开文件时, 通过此表的表项把用户打开文件表的表项与文件活动inode连接起来
3. 主存活动inode表

总结一下, 进程打开文件, 该文件的描述符fd, 通过fd在用户打开文件表中找到系统打开文件表对应的表项, 再根据系统打开文件表的内容, 到主存活动inode表找到对应文件的inode信息, 若不在主存活动inode表中, 还要从磁盘inode区调入. 得到inode信息后就能根据```i_data```数组, 由多级索引的形式, 找到对应的文件内容
## 文件的共享, 保护和保密

### 文件的安全与保护
- 文件共享: 不同用户共同使用某些文件
- 文件保护: 防止文件被破坏
- 文件保密: 防止文件及其内容被其他用户窃取

文件共享的并发控制
- 多个进程可能同时进行读操作, OS应对文件进行公用控制
- 如果有进程进行写操作, 则OS必须提供同步控制机制, 以保证文件数据的完整性

### 文件的共享
#### 静态共享
就是Linux中的链接

#### 动态共享
是系统中不同的用户进程或同一用户的不同进程并发访问同一文件

文件的每次读写都有一个读/写指针, 指出读写的位置, 在动态共享中, 如何处理这个指针?
- 同一用户的父, 子进程协同完成任务时, 使用同一读/写位移指针, 同步地对文件进行操作
- 该位移指针应放在相应文件的系统打开文件表, 当系统调用fork建立子进程时, 父进程的PCB结构被复制到子进程中, 两个进程的用户打开文件表通过系统打开文件表指向同一活动的索引节点, 达到共享同一位移指针的目的
- 多用户共享文件, 每个希望独立地读, 写文件, 这时只有一个读写位移指针就不够了, 须为每个用户进程分别设置一个读, 写位移指针
- 位移指针应放在每个进程的系统打开文件表中, 这样进程之间能独立访问

#### 文件的符号链接共享
符号链接又称软链接, 是一种只有文件名, 不指向inode的文件
### 文件的保护
常用的方法
- 文件副本
- 文件存取矩阵与文件存取表: 记录用户对文件拥有的存取权限
- 文件属性: 读, 写, 执行的权限

## 文件的使用
### 文件的存取方法
- 文件的存取方法是OS为用户程序提供的使用文件的技术和手段
- 在某种程度上依赖于文件的物理结构

#### 顺序存取
按记录顺序进行读/写操作
- 读操作根据读指针读出当前记录, 同时推进读指针, 指向下一个要读出的记录
- 写操作则设置写指针, 把一个记录写到文件末端, 同时推进写指针
- 允许一次推进多个位置

#### 直接存取
很多应用场合要求快速地以任意次序直接读写某个记录

#### 索引存取
基于索引文件的索引存取方式
- 信息块的地址通过查找记录键而换算出
- 除可用按键存取外, 也可以采用顺序存取或直接存取的方法
- 实际的系统中, 大多采用多级索引以加速记录查找过程

### 文件的使用
用户通过两类接口与文件系统联系
- 第一类是文件有关的操作命令
- 第二类是提供给用户程序使用的文件类系统调用

#### 建立文件
在相应设备上建立一个文件目录项, 为文件分配第一个物理块, 在活动文件表中申请一个项, 登记有关目录信息, 并返回一个文件句柄

#### 撤销文件
若文件没有关闭, 先关闭文件; 若为共享文件, 进行联访处理; 在目录文件中扇区相应目录项, 释放文件占用的文件存储空间

#### 打开文件
用于建立文件和用户进程之间的使用联系

在主存活动文件表中申请一个项, 返回一个文件句柄; 根据文件名查找目录文件, 把目录信息复制到活动文件表相应项中; 按存取控制说明检查其访问合法性

#### 关闭文件
将活动文件表中该文件的"当前使用用户数"减1, 若值为0, 则收回此活动文件表; 完成"推迟写"; 若活动文件表内容已被改过, 则应先将表目内容写回文件存储器上相应表目中, 以使文件目录保持最新状态

#### 读/写文件
按文件句柄从活动文件表中找到该文件的目录项信息; 根据目录项指出的该文件的逻辑和物理组织方式, 把相关逻辑记录转换成物理块


#### 定位文件
用于调整所打开文件的读写指针的位置

## 文件系统的实现

### 辅存空间管理
磁盘等大容量辅存空间被OS及许多用户共享, 用户进程运行期间常常要建立和删除文件, OS应能自动管理和控制辅存空间

随着用户文件不断建立和撤销, 文件存储空间会出现许多碎片

OS解决碎片的办法是整理碎片, 在整理过程中往往对文件重新组织, 让其存放在连续存储区中

辅存空间的分配方式
- 连续分配: 存放在辅存空间连续存储区中(连续的物理块号)
  - 优点是顺序访问时速度快, 管理较为简单, 但为了获得足够大的连续存储区, 需定时进行碎片整理
- 非连续分配: 动态分配给若干扇区或簇, 不要求连续
  - 优点是辅存空间管理效率高, 便于文件动态增长和收缩

空闲块的管理: 位示图
- 使用若干字节构成一张表, 表的每一位对应一个物理块, '1'表示占用, '0'表示空闲
- 优点是可以把位示图全部或大部分保存在主存中, 配合现代计算机的位操作指令, 可实现告诉物理块分配和去配

#### Linux空闲块的管理
空闲块成组连接法

把空闲块分组, 组之间链式连接

### 文件系统的实现层次
- 用户接口: 接受用户发来的系统调用, 进行语法检查, 进入逻辑文件控制子系统
- 逻辑文件控制子系统: 根据路径名, 搜索文件目录, 建立活动文件表, 根据文件结构和存取方式, 把逻辑记录转换成相对物理块号和块内相对地址
- 文件保护子系统: 识别调用者身份, 验证存取权限, 判定本次文件操作的合法性
- 物理文件控制子系统: 实现缓冲区管理, 根据物理结构将相对物理块号转换为实际物理块号, 负责文件存储空间的分配, 生成I/O控制系统的调用形式
- I/O控制子系统: 执行具体的物理块I/O操作


### 主存映射文件
首先, 用于读写文件的操作在功能与格式上与读写主存的操作有很大不同, 如果能消除这种差异就能简化编程工作

其次, 文件中的数据是一部分一部分在进程空间与磁盘空间之间传送, 文件操作实现不但管理复杂且开销较大, 能否找出一种方法既降低开销, 又能通过直接读写主存来使用文件信息

最早由MULTICS首创, 通过结合虚存管理和文件管理技术来提供一种新的文件使用方法, 称为主存映射文件
- 系统提供两个新的系统调用
- 映射文件: 把一个文件映射到进程地址空间
- 移去映射文件: 让文件与进程地址空间断开, 把映射文件的数据写回磁盘文件
- 优点是方便易用, 节省空间, 便于共享, 高效灵活
- 进程读写虚存内容就相当于执行文件读写操作, 建立映射后不再需要使用文件系统调用来读写数据

### 虚拟文件系统
第一个虚拟文件系统在SunOS中使用, 虚拟文件系统也称虚拟文件系统开关(VFS)

是内核的一个子系统, 提供一个通用文件系统模型, 概括文件系统的常用功能和行为, 处理一切和底层设备驱动相关的细节, 为应用程序提供标准的接口(文件系统API)

虚拟文件系统应实现以下目标
- 支持多种文件系统
- 多个文件系统应与传统的单一文件系统在用户面前没有区别, 表现为一致的接口
- 提供通过网络共享文件的支持, 应与访问本地的文件一致
- 可以开发出新的文件系统, 以模块化的方式加入到操作系统中

设计思想
- 应用层: 源于UNIX文件系统, 可直接使用标准UNIX文件系统调用, 无需考虑具体文件系统和物理存储介质
- 虚拟层: 对所有具体文件系统的共同特性进行抽象, 形成一个与具体文件系统实现无关的虚拟层
- 实现层: 使用类似开关表技术进行具体文件系统转接, 实现各种具体文件系统的细节

VFS实质上是一种存在于主存中的, 支持多种类型具体文件系统的运行环境, 功能有
- 记录安装的文件系统类型
- 建立设备与文件系统的联系
- 实现面向文件的通用操作
- 涉及特定文件系统的操作时, 映射到具体文件系统中去


VFS的组成(主要数据结构)
- 超级块对象: 代表一个文件系统
- 索引节点对象: 代表一个文件
- 目录项对象: 代表路径中的一个组成部分
- 文件对象: 代表由进程已打开的一个文件


#### 超级块
- 存放已安装的文件系统信息
- 如Ext2超级块, 当内核对一个具体文件系统进行初始化和注册时, 调用alloc_super()函数为其分配一个VFS超级块, 并从磁盘读取具体文件系统超级块中的信息填充进来, 可见VFS超级块仅存于主存中

#### 索引节点
- 存放通用的文件信息, 如基于磁盘的文件系统, 对应于文件的FCB, 即每个文件的inode对象, 而每个inode都有一个inode索引节点号, 唯一地标识某个文件系统中的指定文件
- 对于UNIX类文件系统, 这些信息从磁盘的inode直接读入VFS的inode对象, 磁盘上的inode称为静态节点, 读入内存的VFS的inode称为动态节点

#### 目录项
- 存放目录项与对应文件进行链接的各种信息, VFS把最近最常使用的dentry放在目录项高速缓存中

#### 文件
- 存放已打开文件与进程的交互信息, 仅当进程访问文件期间才存于主存
- 在执行系统调用open()时创建, 执行close()时撤销
- 每个文件都用一个32位数字来表示下一个读写的字节位置, 称为文件位置或偏移量
- Linux建立文件对象来保存打开文件的文件位置, 还把指向该文件inode的目录项指针也放在其中, 形成一个双向链表, 这就是**系统打开文件表**
- OS不直接使用dentry是因为多个进程能打开同一个文件, 每个file结构实际上对应一个进程的一次打开过程
- 文件描述符fd用来描述打开的文件, 每个进程用一个```files_struct```结构来记录fd的使用情况, 这就是**用户打开文件表**