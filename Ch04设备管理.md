# Ch04 设备管理

## 设备管理基础
### 设备管理概述
I/O设备: 又称输入输出设备, 外围设备, 外部设备, 外设
- 用于计算机系统与外部世界(如用户, 其他计算机或设备)的信息交换或存储

I/O操作: **内存**和**外设**间的信息传送操作

I/O设备的分类(信息传输视角)
1. 输入设备
2. 输出设备
3. 输入输出设备

I/O设备的分类(交互功能视角)
1. 人机交互设备
2. 存储设备
3. 机机通信设备

I/O设备的分类(设备管理视角)
1. 字符设备 *显示器*
2. 块设备 *磁盘*
3. 网络设备 *网卡*: 既可抽象为字符设备也可抽象为块设备

设备管理的目标
- 解决设备和CPU速度的不匹配, 使主机和设备充分并行工作, 提高设备使用效率
- 屏蔽设备的物理细节和操作过程, 配置驱动程序, 提供统一界面

设备管理的功能
- 设备中断处理
- 缓冲区管理
- 设备的分配和去配
- 设备驱动调度
- 虚拟设备的实现

设备管理的实现层次
- I/O硬件
  - I/O设备及其接口线路
  - 控制部件
  - 通道
- I/O软件
  - 系统I/O软件
  - 用户空间I/O软件

### I/O控制方式
设备控制器
- 为达到模块化和通用性的设计目标, 通常分开设置设备的机械部件和电子部件
- 电子部件被称为设备控制器, 又称为设备适配器, I/O控制器, I/O控制接口, I/O模块
- 系统与控制器交互, 而非与设备交互
- 再由设备控制器具体控制设备进行I/O

设备控制器的功能: 是CPU与设备之间的接口
- 接受和识别CPU或通道发来的命令
- 实现数据交换
- 发现和记录设备及自身的状态信息, 供CPU处理和使用
- 当连接多台设备时, 识别设备地址


#### I/O控制的轮询方式
- 处理器向控制器发送I/O命令, 轮询I/O结果
- 若设备未就绪, 则重复测试过程, 直至就绪
- 执行内存数据交换
- 等待I/O操作完成后, 处理器才可以继续其他操作

**CPU等待设备就绪, 且参与内存数据交换**
#### I/O控制的中断方式
- 处理器向控制器发出具体I/O命令, 然后继续执行后续指令
  - 若该进程支持异步I/O, 则后续指令仍是该进程的指令
  - 否则, 该进程在这个中断上挂起, 处理器执行其他工作
- 控制器检查设备状态, 就绪后发出中断
- CPU响应中断, 进行中断处理
- 中断处理执行内存数据交换

**CPU无需等待设备就绪, 响应中断后参与内存数据交换**

#### I/O控制的DMA方式
是直接存储器访问
- DMA模块能替代处理器来控制主存和设备控制器间的数据交换
- 处理器向DMA模块发出I/O命令, 然后继续执行其他工作
- DMA模块负责传送全部数据
- 数据传送结束后, DMA中断处理器

DMA方式中的周期窃取
- DMA和CPU同时通过总线访问内存, CPU会把总线的占有权让给DMA几个主存周期
- 周期窃取对CPU与主存的数据交换影响不大, 因为
  - 数据传送过程是不连续的和不规则的
  - CPU大部分情况下与Cache进行数据交换, 直接访问内存较少

**CPU只在I/O开始和结束时参与, 不参与主存数据交换**
#### I/O通道
又称为通道控制器, I/O处理器, 用于完成逻辑上独立的I/O任务

采用四级连接: 处理器, 通道, 控制器, 设备
- 通道可控制多台同类或不同类的设备
- 处理器不再执行I/O指令, 而是在主存中组织通道程序, 由I/O通道执行

I/O通道的工作流程
1. CPU遇到I/O任务, 组织通道程序, 置通道程序地址字CAW, 启动指定通道
2. 通道从CAW获得通道程序, 控制I/O设备进行操作, CPU执行其他任务
3. I/O操作完成后, I/O通道发出中断, CPU处理中断, 并从通道程序状态字CSW获得通道执行情况, 处理I/O操作
4. **CPU与通道高度并行工作**

### 总线与I/O
为什么要有总线: 解决I/O速度不匹配问题
- I/O和CPU速度不匹配
- 各设备I/O速度不匹配

#### 单总线结构模型
将CPU, 主存和I/O模块连接到同一总线

优点
- 结构简单, 易于扩充
缺点
- 共用总线, 设备多时总线压力大, 传输时延长, 且慢速设备占用带宽多

#### 三级总线模型
主存和Cache通过主存总线连接, 外设之间通过扩展总线连接, CPU和Cache通过局部总线连接, 扩展总线借口连接主存总线

优点
- 主存与I/O之间的数据传送, 处理器的内存活动分离, 可以支持更多的I/O设备
缺点
- 不适用于I/O设备数据速率相差太大的情况: 扩展总线（连接所有 I/O 设备）在扩展总线上快的设备要等慢的设备使用完总线才可以使用

#### 南桥与北桥
通过存储总线, PCI总线, E(ISA)总线分别连接主存, 高速I/O设备和低速I/O设备
![alt text](/assets/image7.png)

优点
- PCI总线和E(ISA)总线可以支持不同数据速率的I/O设备

#### 一种基于通道的服务器总线模型
- 支持CPU, 主存和多个I/O通道之间的数据传送
- 支持I/O通道和I/O控制器, 以及I/O控制器和设备之间的数据传送
![alt text](/assets/image8.png)

## 设备管理软件
### I/O软件的实现层次
I/O软件的设计目标
- 高效率
- 通用性

设计思想
- 把软件组织成层次结构
- 低层软件用来屏蔽硬件细节
- 高层软件用来向用户提供简洁, 友善, 统一的界面

I/O软件设计要考虑的问题
- 设备无关性: 访问设备的程序与具体设备无关
- 出错处理: 低层软件能处理的错误不让高层软件感知
- 同步/异步传输: 支持阻塞和中断驱动两种工作方式
  - 异步传输: CPU在启动I/O操作后即可继续工作, 直到中断到达
  - 同步传输: 阻塞方式, 让启动I/O操作的进程阻塞等待, 直到数据传输完成
- 缓冲技术: 建立内存数据缓冲区, 提高吞吐率

I/O软件的层次结构
![alt text](/assets/image9.png)

I/O操作执行步骤
1. 进程对已打开文件的文件描述符执行读库函数
2. 与设备无关的I/O软件检查参数正确性. 若高速缓存中有要读的信息块, 从缓冲区直接读到用户区, 完成I/O请求
3. 若数据不在缓冲区, 执行物理I/O, 实现将设备逻辑名转换成物理名, 检查对设备操作的权限, 将I/O请求排队, 阻塞进程且等待I/O完成
4. 内核启动设备驱动程序, 分配存放读出块的缓冲区, 准备接收数据, 且向设备控制寄存器发启动命令, 或建立DMA传输, 启动I/O
5. 设备控制器操作设备, 执行数据传输
6. 传输完成硬件产生I/O结束中断
7. CPU响应中断, 转向磁盘中断处理程序(之前告诉缓存中没有数据产生的中断)
8. 当进程被再次调度执行时, 从I/O系统的断点恢复执行

### I/O软件的实现

#### I/O中断处理程序
位于OS底层, 与硬件设备密切相关, 与系统其余部分尽可能少地发生联系

进程请求I/O操作时, 通常被阻塞

数据传输结束后产生I/O中断

CPU响应请求并转入中断处理程序

功能
- 检查设备状态寄存器, 判断中断原因, 根据I/O操作完成情况进行相应处理
- 若数据传输有错, 向上层软件报告设备的出错信息, 实施重新执行
- 若正常结束, 唤醒等待传输的进程, 使其转换为就绪态
- 如果有等待传输的I/O命令, 通知相关软件启动下一个I/O请求

#### 设备驱动程序
包括与设备密切相关的所有代码

从独立于设备的软件中接收I/O请求

把用户提交的逻辑I/O请求转化为物理I/O操作的启动和执行

监督设备是否正确执行, 访问数据缓冲区, 进行必要的纠错处理

功能
- 设备初始化
- 执行设备驱动例程: 负责启动设备, 进行数据传输; 对于通道, 还负责组织通道程序, 启动通道工作
- 执行与设备相关的具体中断处理

每个设备驱动程序原则只处理一种设备或者一类紧密相关的设备

设备驱动程序也可以分层实现
- 高层: 处理类设备; 低层: 处理具体设备
- 系统建立栈, 接到I/O请求时先调用栈顶的驱动程序, 然后继续向下调用底层的驱动程序, 直至所有物理操作被处理
- 这一方式使驱动的实现结构清晰, 便于移植, 但会增加系统开销

#### 独立于设备的I/O软件
执行适用于所有设备的常用I/O功能, 并向用户层软件提供一致性接口, 包括
- 设备命名
- 设备保护
- 提供与设备无关的数据单位
- 缓冲技术
- 分配和状态跟踪
- 错误处理/报告

#### 用户空间的I/O软件
库函数: 一部分I/O软件可以使用库函数实现, 放在操作系统内核之外, 运行时与应用程序链接

虚拟设备软件: 用一类设备模拟另一类设备的仿真I/O软件

### I/O缓冲
设置I/O缓冲的目的
- 解决CPU与设备之间速度不匹配的矛盾 *总线也是为了解决这个问题*
- 协调逻辑记录大小和物理记录大小不一致的问题
- 提高CPU和设备的并行性
- 减少I/O操作和对CPU的中断次数
- 放宽对CPU中断响应时间的要求

I/O缓冲区: 在内存中开辟的存储区, 专门用于临时存放I/O操作的数据
- 写操作: 将数据送至缓冲区, 直到装满或需要写出, 待适当时候系统将缓冲区内容写到设备上
- 读操作: 系统将设备上的物理记录读至缓冲区, 根据要求将当前所需要的数据从缓冲区读出并传送给进程

单缓冲技术: 只有一个缓冲区

双缓冲技术: 在主存系统区开设两个缓冲区
- 读操作: 先把数据输入缓冲区1, 再从缓冲区1把数据传到用户区, 供应用程序处理, 同时设备可将数据传送到缓冲区2
- 写操作: 先将数据从用户区传送到缓冲区1, 再将数据传送到设备, 同时应用程序可将数据送到缓冲区2

循环缓冲技术: OS分配一组缓冲区, 每个缓冲区有指向下个缓冲区的指针, 构成循环缓冲

## 独占型外围设备的分配

### 设备独立性
作业执行前对设备提出申请, 指定某台具体物理设备会让设备分配变得简单, 但若所指定设备出现故障, 即便计算机系统中有同类设备也不能运行

引出设备独立性的概念
- 用户通常不指定物理设备, 而是指定逻辑设备, 使得用户进程和物理设备分离开, 再通过其他途径建立逻辑设备和物理设备之间的映射
- 设备管理中需要将逻辑设备名转换成物理设备名, 因此系统需要提供逻辑设备名和物理设备名的对应表以供转换

设备独立性的优点
- 应用程序与具体物理设备无关, 系统增减或变更设备时不需要修改源程序
- 易于应对各种I/O设备故障, 提高系统的可靠性
- 增加设备分配的灵活性, 有利于更加有效地利用设备资源, 实现多道程序设计

### 独占型外围设备的分配
一次只能由一个进程独占使用的设备

分配方式
- 静态分配: 进程运行前申请
  - 实现简单, 能够防止系统发生死锁, 但会降低设备利用率
- 动态分配: 进程随用随申请
  - 考虑互斥管理, 需要结合信号量和PV操作
  - 能提高设备利用率, 但可能会带来死锁问题

设备分配的数据结构
- 设备类表
  - 每类设备对应于表中一栏
  - 包括设备类, 总台数, 空闲台数, 设备表起始地址等
  - 支持设备独立性时使用
- 设备表
  - 每类设备都有自己的设备表, 用来登记这类设备中的每台物理设备
  - 包括物理设备名, 逻辑设备名, 占有设备的进程, 分配标志, 好/坏标志等

## 共享型外围设备的驱动
1. 磁带与磁盘的本质区别: 磁带是顺序访问, 磁盘是随机访问
2. 磁盘的进步, 意义是什么: 数据的存储空间和读存取速度都飞速发展
### 磁盘的物理结构
- 磁盘一般由多个盘片组成
- 每个盘片一般有两个盘面
- 盘面包括多个同心圆结构的磁道, 不同盘面上位于相同位置的磁道构成柱面
- 每个磁道分为固定多个扇区(一个扇区大小为512B), 相邻扇区组合成簇

磁盘上物理块地址的表示
- 盘面号, 磁道号, 扇区号

### 磁盘读写数据的方式
读写数据时, 磁头必须定位到指定磁道上的指定扇区的开始处
1. 寻道: 控制移动臂到达指定柱面
2. 旋转: 等待要读写的扇区旋转到磁头下
3. 选择磁头号: 因为同一个柱面上有很多个盘面, 每个盘面上都有一个磁头, 需要选择使用的指定磁头, 然后进行数据传送

磁盘存取时间
- 寻道时间 + 旋转延迟 + 传送时间

$T_a = T_S + \frac{1}{2r} + \frac{b}{rN}$

- $T_S$ 寻道时间, 即将移动臂移动到指定柱面的时间, 和移动臂移动的距离成正比
- $r$: 磁盘的旋转速度, 因为无法预估什么时候扇区旋转到磁头下, 所以取一个平均旋转延迟, 即转过半圈的时间$\frac{1}{2r}$
- $b$: 要传送的字节数
- $N$: 一个磁道中的字节数, 因为磁道是一个同心圆, 那么读取一个磁道所花费的时间为$\frac{1}{r}$, 那么读取$b$个字节所花费的时间为$\frac{b}{N} \times \frac{1}{r}$

### 磁盘的驱动调度
磁盘可能同时接受到若干I/O请求, 若随机响应I/O请求, 会得到很坏的性能

驱动调度: OS的磁盘调度策略, 即按照最佳次序执行处理访问磁盘的多个I/O请求, 以减少磁盘访问的总处理时间

驱动调度策略包括
- 移臂调度
- 旋转调度

#### 移臂调度及算法
目的: 使移动臂的时间最短, 从而减少寻道总时间

1. 先来先服务: 移动距离大, 性能不好
2. 最短查找时间优先: 先执行查找时间最短的请求, 具有较好的寻道性能, 但存在饥饿现象
3. 扫描算法
   1. 单向扫描(C-SCAN): 移动臂向一个方向扫描, 归程不处理服务没适用于不断有均匀分布的大量柱面请求
   2. 双向扫描(SCAN): 归程也进行服务
   3. 电梯调度(LOOK): 双向扫描的改进, 当前移动方向没有访问请求时就改变方向
   4. 分布扫描(N-step-SCAN): 把磁盘请求队列分成多个长度为N的子队列, 每次用SCAN处理一个子队列, 在处理一个队列时, 新请求必须添加到其他队列
   5. FSCAN: 使用两个子队列, 开始时所有请求都在一个队列, 扫描过程中新到的请求加入另一个队列, 只有一个队列全部结束才处理另一个队列
4. 优先级调度
5. 后进先出: 在事务处理中, 把设备资源提供给最近的用户, 磁头臂在处理顺序文件中移动时移动得很少
#### 旋转调度
目的: 使得旋转延迟的总时间最少

旋转排序
- 通过优化I/O请求排序, 在最少旋转圈数内完成对于同一柱面的访问请求
- 旋转位置测定硬件和多磁头同时读写技术有利于提高旋转调度的效率

优化分布
- 通过磁盘上信息的排列方式来减少旋转延迟
- 交替排序: 由于磁盘匀速旋转, 可能处理当前扇区数据时, 下个扇区已经跳过, 因此可将同一内容间隔几个扇区排布
- 把相邻扇区集中成簇读写
- 按柱面集中存储数据(另一种集簇方式), 相同内容都放在同一个柱面的不同盘面上, 可以减少数据读写时的移臂操作

### 磁盘冗余阵列-RAID技术

#### RAID0
无冗余

#### RAID1
镜像所有数据来提高容错性, 读请求寻道时间最小(因为两份磁盘都能寻道), 写请求可并行完成, 缺点是容量下降一半

#### RAID2
通过海明码冗余

#### RAID3
交错位奇偶校验

#### RAID4
块奇偶校验

#### RAID5
块分布奇偶校验

#### RAID6
双重冗余

#### RAID10
RAID1 加 RAID0
## 虚拟设备
### SPOOLing系统
虚拟设备技术: 使用一类物理设备模拟另一类物理设备的技术
- 内存卡模拟磁盘
- 块设备模拟字符设备
- 输入输出的重定向

SPOOLing系统(外部设备联机并行操作): Simultaneous Peripheral Operations On-Line. 它是关于慢速字符设备如何与计算机主机交换信息的一种技术, 通常称为**假脱机技术**
- 是一种以共享型磁盘设备模拟独占型物理设备的技术, 也是一种速度匹配技术
- 在操作系统中实现这种技术的功能模块被称为SPOOLing系统

一个经典的SPOOLing系统
- 用高速的磁盘设备来模拟慢速的字符设备, 缩短进程在内存中的驻留时间
- 慢速输出设备先输出到输出井
- 进程运行过程中只从输入井读入数据, 只向输出井输出数据, 使得全部I/O基于磁盘
- 加快进程的周转时间, 提高系统吞吐量

该SPOOLing系统的软件组成
- 预输入程序: 预先把数据从输入设备传送到磁盘输入井
- 缓输出程序: 把程序从磁盘输出井传送到输出设备
- 井管理程序: 控制进程和井之间的数据交换, 事实上是**I/O重定向**

打印SPOOLing系统: 打印机守护进程和SPOOLing打印目录
- 守护进程是唯一有特权使用打印机设备的进程
- 打印文件前, 用户进程先产生完整的待输出文件, 存放在打印目录下
- 当打印机空闲时, 启动守护进程, 打印待输出文件

![alt text](/assets/image11.png)
### 批处理系统的作业管理

作业调度与进程调度的关系
![alt text](/assets/image10.png)

作业是用户视角的任务单元

进程是OS视角的执行实体

处理器的高级调度: 实际上就是决定作业调度(选中并创建进程)


> 用户提交编译作业 → 作业进入后备队列
> 
> 作业调度器选中该作业 → 创建主进程（gcc）
> 
> 主进程fork子进程（cc1/as/ld）→ 进程调度器分配CPU时间片
> 
> 所有进程退出 → 作业状态标记为完成